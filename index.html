<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ù„Ø¹Ø¨Ø© Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„ÙŠÙˆÙ…ÙŠØ© - Crynova</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    :root {
      --primary: #0072ff;
      --secondary: #ff2d9e;
      --accent: #7d3dff;
      --danger: #ff4757;
      --success: #26a17b;
      --warning: #ff9f00;
      --info: #2d87ff;
      --bg-light: #ffffff;
      --bg-lighter: #f8f9fa;
      --text-dark: #1a1a1a;
      --text-gray: #666;
      --text-light: #888;
      --border-light: rgba(0, 0, 0, 0.1);
      --shadow-light: rgba(0, 0, 0, 0.08);
    }

    body {
      background: linear-gradient(135deg, #f8f9fa, #e9ecef);
      color: var(--text-dark);
      min-height: 100vh;
      padding: 20px;
      padding-bottom: 90px;
    }

    .container {
      max-width: 500px;
      margin: 0 auto;
    }

    .game-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      background: linear-gradient(90deg, var(--primary), var(--accent));
      color: white;
      padding: 15px 20px;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0, 114, 255, 0.3);
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .user-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: linear-gradient(135deg, #ffffff, #f8f9fa);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-weight: bold;
      color: var(--primary);
      border: 3px solid rgba(255, 255, 255, 0.5);
    }

    .user-details h2 {
      font-size: 18px;
      margin-bottom: 4px;
    }

    .user-details p {
      font-size: 12px;
      opacity: 0.9;
    }

    .user-username {
      font-size: 11px !important;
      color: rgba(255, 255, 255, 0.8) !important;
      margin-bottom: 2px !important;
      direction: ltr;
      text-align: left;
    }

    .points-display {
      text-align: center;
      background: rgba(255, 255, 255, 0.2);
      padding: 8px 15px;
      border-radius: 30px;
      backdrop-filter: blur(5px);
    }

    .points-display .amount {
      font-size: 24px;
      font-weight: bold;
      font-family: 'Arial', sans-serif;
      direction: ltr;
    }

    .points-display .label {
      font-size: 12px;
    }

    .daily-checkin-card {
      background: white;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 20px var(--shadow-light);
      border: 1px solid rgba(0, 114, 255, 0.1);
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 15px;
    }

    .card-header h3 {
      font-size: 18px;
      color: var(--text-dark);
    }

    .streak-badge {
      background: linear-gradient(90deg, var(--warning), #ff6b00);
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: bold;
    }

    .compact-calendar {
      text-align: center;
      margin-bottom: 20px;
    }

    .circle-calendar {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }

    .calendar-circle {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      background: var(--bg-lighter);
      color: var(--text-light);
      border: 1px solid transparent;
    }

    .calendar-circle:hover {
      transform: scale(1.1);
      border-color: var(--primary);
    }

    .calendar-circle.checked {
      background: linear-gradient(135deg, var(--success), #1dd1a1);
      color: white;
    }

    .calendar-circle.today {
      background: linear-gradient(135deg, var(--primary), var(--accent));
      color: white;
      animation: pulse 2s infinite;
      box-shadow: 0 0 0 2px rgba(0, 114, 255, 0.2);
    }

    .calendar-circle.future {
      background: var(--bg-lighter);
      color: var(--text-light);
      opacity: 0.7;
    }

    .calendar-circle.special {
      border: 1px solid var(--warning);
    }

    .circle-day {
      font-size: 12px;
    }

    .circle-check {
      display: none;
      font-size: 11px;
    }

    .calendar-circle.checked .circle-check {
      display: block;
    }

    .calendar-circle.checked .circle-day {
      display: none;
    }

    .circle-today {
      display: none;
      font-size: 11px;
      animation: bounce 1s infinite;
    }

    .calendar-circle.today .circle-today {
      display: block;
    }

    .calendar-circle.today .circle-day {
      display: none;
    }

    .circle-bonus {
      position: absolute;
      top: -5px;
      right: -5px;
      background: var(--warning);
      color: white;
      font-size: 9px;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .calendar-progress {
      margin-top: 15px;
    }

    .progress-bar {
      height: 6px;
      background: var(--bg-lighter);
      border-radius: 3px;
      overflow: hidden;
      margin-bottom: 5px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--accent));
      border-radius: 3px;
    }

    .progress-text {
      font-size: 12px;
      color: var(--text-light);
      font-family: 'Arial', sans-serif;
      direction: ltr;
    }

    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(0, 114, 255, 0.4); }
      70% { box-shadow: 0 0 0 5px rgba(0, 114, 255, 0); }
      100% { box-shadow: 0 0 0 0 rgba(0, 114, 255, 0); }
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-2px); }
    }

    .checkin-button {
      width: 100%;
      padding: 16px;
      border-radius: 12px;
      border: none;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      color: white;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      box-shadow: 0 4px 16px rgba(0, 114, 255, 0.2);
    }

    .checkin-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 114, 255, 0.3);
    }

    .checkin-button:disabled {
      background: #cccccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .checkin-button.checked {
      background: linear-gradient(90deg, var(--success), #1dd1a1);
    }

    .daily-tasks-card {
      background: white;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 20px var(--shadow-light);
      border: 1px solid rgba(0, 114, 255, 0.1);
    }

    .tasks-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 15px;
    }

    .task-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px;
      border-radius: 12px;
      background: var(--bg-lighter);
      border: 1px solid transparent;
      transition: all 0.3s ease;
    }

    .task-item:hover {
      border-color: var(--primary);
      transform: translateY(-2px);
    }

    .task-item.completed {
      background: rgba(38, 161, 123, 0.1);
      border-color: var(--success);
    }

    .task-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .task-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      color: white;
    }

    .task-details h4 {
      font-size: 14px;
      margin-bottom: 4px;
    }

    .task-details p {
      font-size: 12px;
      color: var(--text-light);
    }

    .task-reward {
      background: linear-gradient(90deg, var(--warning), #ff6b00);
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: bold;
      font-family: 'Arial', sans-serif;
      direction: ltr;
    }

    .task-action {
      padding: 8px 16px;
      border-radius: 10px;
      border: none;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Arial', sans-serif;
      direction: ltr;
    }

    .task-action:hover {
      transform: scale(1.05);
    }

    .task-action.completed {
      background: var(--success);
    }

    .achievements-card {
      background: white;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 20px var(--shadow-light);
      border: 1px solid rgba(0, 114, 255, 0.1);
    }

    .achievements-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-top: 15px;
    }

    .achievement-item {
      background: var(--bg-lighter);
      border-radius: 12px;
      padding: 15px;
      text-align: center;
      transition: all 0.3s ease;
    }

    .achievement-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px var(--shadow-light);
    }

    .achievement-item.locked {
      opacity: 0.6;
      filter: grayscale(0.5);
    }

    .achievement-icon {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      margin: 0 auto 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      color: white;
    }

    .achievement-item.locked .achievement-icon {
      background: linear-gradient(135deg, #cccccc, #999999);
    }

    .achievement-item h4 {
      font-size: 14px;
      margin-bottom: 5px;
    }

    .achievement-item p {
      font-size: 12px;
      color: var(--text-light);
      margin-bottom: 8px;
    }

    .achievement-reward {
      font-size: 12px;
      font-weight: bold;
      color: var(--warning);
      background: rgba(255, 159, 0, 0.1);
      padding: 4px 8px;
      border-radius: 10px;
      display: inline-block;
      font-family: 'Arial', sans-serif;
      direction: ltr;
    }

    .leaderboard-card {
      background: white;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 20px var(--shadow-light);
      border: 1px solid rgba(0, 114, 255, 0.1);
    }

    .leaderboard-tabs {
      display: flex;
      margin-bottom: 15px;
      background: var(--bg-lighter);
      border-radius: 12px;
      padding: 4px;
    }

    .leaderboard-tab {
      flex: 1;
      text-align: center;
      padding: 10px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s ease;
    }

    .leaderboard-tab.active {
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      color: white;
    }

    .leaderboard-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .leaderboard-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px;
      border-radius: 12px;
      background: var(--bg-lighter);
    }

    .leaderboard-item.me {
      background: rgba(0, 114, 255, 0.1);
      border: 1px solid rgba(0, 114, 255, 0.2);
    }

    .leaderboard-rank {
      font-weight: bold;
      font-size: 18px;
      width: 30px;
      text-align: center;
      font-family: 'Arial', sans-serif;
      direction: ltr;
    }

    .leaderboard-rank.top-1 { color: gold; }
    .leaderboard-rank.top-2 { color: silver; }
    .leaderboard-rank.top-3 { color: #cd7f32; }

    .leaderboard-user {
      display: flex;
      align-items: center;
      gap: 10px;
      flex: 1;
    }

    .leaderboard-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
    }

    .leaderboard-name {
      font-weight: bold;
    }

    .leaderboard-points {
      font-weight: bold;
      color: var(--primary);
      font-family: 'Arial', sans-serif;
      direction: ltr;
    }

    .friends-card,
    .gifts-card,
    .challenges-card,
    .groups-card,
    .referrals-card,
    .shop-card,
    .advanced-referral-card {
      background: white;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 20px var(--shadow-light);
      border: 1px solid rgba(0, 114, 255, 0.1);
    }

    .gift-item, .challenge-item, .group-item, .shop-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px;
      border-radius: 12px;
      background: var(--bg-lighter);
      margin-bottom: 10px;
      border: 1px solid transparent;
      transition: all 0.3s ease;
    }

    .gift-item:hover, .challenge-item:hover, .group-item:hover, .shop-item:hover {
      border-color: var(--primary);
      transform: translateY(-2px);
    }

    .gift-info, .challenge-info, .group-info, .shop-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .gift-icon, .challenge-icon, .group-icon, .shop-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      color: white;
    }

    .gift-details h4, .challenge-details h4, .group-details h4, .shop-details h4 {
      font-size: 14px;
      margin-bottom: 4px;
    }

    .gift-details p, .challenge-details p, .group-details p, .shop-details p {
      font-size: 12px;
      color: var(--text-light);
    }

    .gift-action, .challenge-action, .group-action, .shop-action {
      padding: 8px 16px;
      border-radius: 10px;
      border: none;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 12px;
      min-width: 110px;
      text-align: center;
      font-family: 'Arial', sans-serif;
      direction: ltr;
    }

    .gift-action:hover, .challenge-action:hover, .group-action:hover, .shop-action:hover {
      transform: scale(1.05);
    }

    .friends-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 15px;
    }

    .friend-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px;
      border-radius: 12px;
      background: var(--bg-lighter);
    }

    .friend-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .friend-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
    }

    .friend-name {
      font-weight: bold;
      font-size: 14px;
    }

    .friend-status {
      font-size: 11px;
      color: var(--text-light);
    }

    .friend-status.online {
      color: var(--success);
    }

    .referral-link {
      background: var(--bg-lighter);
      padding: 15px;
      border-radius: 12px;
      margin-top: 15px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .referral-link input {
      flex: 1;
      border: none;
      background: transparent;
      padding: 8px;
      font-size: 14px;
      color: var(--text-dark);
      font-family: 'Arial', sans-serif;
      direction: ltr;
    }

    .referral-link button {
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
    }

    .referral-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 15px;
    }

    .referral-stat {
      background: var(--bg-lighter);
      padding: 12px;
      border-radius: 12px;
      text-align: center;
    }

    .referral-stat .value {
      font-size: 24px;
      font-weight: bold;
      color: var(--primary);
      font-family: 'Arial', sans-serif;
      direction: ltr;
    }

    .referral-stat .label {
      font-size: 12px;
      color: var(--text-light);
    }

    .advanced-referral-card h3 {
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--primary);
    }

    .referral-link-container {
      background: linear-gradient(135deg, rgba(0, 114, 255, 0.05), rgba(125, 61, 255, 0.05));
      padding: 15px;
      border-radius: 12px;
      margin-bottom: 15px;
      border: 1px solid rgba(0, 114, 255, 0.1);
    }

    .referral-link-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .referral-link-title {
      font-weight: bold;
      font-size: 14px;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .referral-link-value {
      font-size: 12px;
      color: var(--text-light);
      margin-top: 5px;
      word-break: break-all;
      padding: 8px;
      background: var(--bg-lighter);
      border-radius: 8px;
      direction: ltr;
      text-align: left;
      font-family: 'Arial', sans-serif;
    }

    .copy-referral-btn {
      background: linear-gradient(90deg, var(--primary), var(--accent));
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .referral-info-text {
      font-size: 12px;
      color: var(--text-light);
      display: flex;
      align-items: center;
      gap: 5px;
      margin-top: 10px;
    }

    .referral-stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }

    .referral-stat-card {
      background: var(--bg-lighter);
      padding: 12px;
      border-radius: 10px;
      text-align: center;
      border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .referral-stat-value {
      font-size: 20px;
      font-weight: bold;
      color: var(--primary);
      margin-bottom: 5px;
      font-family: 'Arial', sans-serif;
      direction: ltr;
    }

    .referral-stat-label {
      font-size: 11px;
      color: var(--text-light);
    }

    .referral-rewards-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
      margin-bottom: 15px;
    }

    .referral-reward-card {
      background: var(--bg-lighter);
      padding: 15px;
      border-radius: 12px;
      border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .reward-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .reward-title {
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--primary);
    }

    .reward-badge {
      font-size: 12px;
      background: linear-gradient(90deg, var(--primary), var(--accent));
      color: white;
      padding: 4px 8px;
      border-radius: 20px;
      font-family: 'Arial', sans-serif;
      direction: ltr;
    }

    .reward-description {
      font-size: 12px;
      color: var(--text-light);
      line-height: 1.5;
    }

    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      border-top: 1px solid var(--border-light);
      box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.08);
      z-index: 1000;
      max-width: 500px;
      margin: 0 auto;
      display: flex;
      padding: 12px 20px;
      justify-content: space-around;
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      cursor: pointer;
      transition: all 0.3s ease;
      color: var(--text-light);
      text-decoration: none;
      font-size: 11px;
    }

    .nav-item.active {
      color: var(--primary);
    }

    .nav-item i {
      font-size: 18px;
    }

    .nav-item span {
      font-size: 10px;
      font-weight: 500;
    }

    .nav-item:hover {
      transform: translateY(-2px);
    }

    .floating-message {
      position: fixed;
      top: 20px;
      right: 50%;
      transform: translateX(50%);
      background: linear-gradient(90deg, var(--success), #1dd1a1);
      color: white;
      padding: 12px 20px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      z-index: 1001;
      animation: slideDown 0.5s ease, fadeOut 0.5s ease 2s forwards;
      max-width: 300px;
      text-align: center;
      font-family: 'Arial', sans-serif;
      direction: ltr;
    }

    @keyframes slideDown {
      from {
        top: -100px;
        opacity: 0;
      }
      to {
        top: 20px;
        opacity: 1;
      }
    }

    @keyframes fadeOut {
      to {
        opacity: 0;
        visibility: hidden;
      }
    }

    .points-animation {
      position: fixed;
      pointer-events: none;
      z-index: 1000;
      animation: floatUp 1s ease forwards;
      font-family: 'Arial', sans-serif;
      direction: ltr;
    }

    @keyframes floatUp {
      0% {
        opacity: 1;
        transform: translateY(0);
      }
      100% {
        opacity: 0;
        transform: translateY(-50px);
      }
    }

    .section-hidden {
      display: none;
    }

    .english-numbers {
      font-family: 'Arial', sans-serif;
      direction: ltr;
    }

    .loading-container {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    .loading-spinner {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    .loading-text {
      color: white;
      font-size: 18px;
      font-weight: bold;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .firebase-status {
      position: fixed;
      top: 10px;
      right: 10px;
      padding: 8px 15px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: bold;
      z-index: 1002;
      display: none;
      animation: slideDown 0.5s ease;
    }
    
    .firebase-status.success {
      background: var(--success);
      color: white;
    }
    
    .firebase-status.error {
      background: var(--danger);
      color: white;
    }
    
    .firebase-status.warning {
      background: var(--warning);
      color: white;
    }
    
    .user-search-result {
      margin-top: 10px;
      padding: 10px;
      border-radius: 8px;
      font-size: 12px;
      display: none;
    }
    
    .user-search-result.found {
      background: rgba(38, 161, 123, 0.1);
      border: 1px solid var(--success);
    }
    
    .user-search-result.not-found {
      background: rgba(255, 71, 87, 0.1);
      border: 1px solid var(--danger);
    }
  </style>
</head>
<body>
  <div id="loadingScreen" class="loading-container">
    <div class="loading-spinner"></div>
    <div class="loading-text">Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨Ùƒ...</div>
  </div>

  <div id="firebaseStatus" class="firebase-status"></div>

  <div id="gameContainer" class="container" style="display: none;">
    <div class="game-header">
      <div class="user-info">
        <div class="user-avatar" id="userAvatar">A</div>
        <div class="user-details">
          <h2 id="userName">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</h2>
          <div id="userUsername" class="user-username" style="display: none;"></div>
          <p>Ù…Ø³ØªÙˆÙ‰: <span id="userLevel" class="english-numbers">1</span></p>
        </div>
      </div>
      <div class="points-display">
        <div class="amount" id="totalPoints">0</div>
        <div class="label">Ù†Ù‚Ø·Ø©</div>
      </div>
    </div>

    <div id="sectionHome">
      <div class="daily-checkin-card">
        <div class="card-header">
          <h3><i class="fas fa-calendar-check"></i> Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙŠÙˆÙ…ÙŠ</h3>
          <div class="streak-badge" id="streakBadge">ğŸ”¥ <span class="english-numbers">0</span> Ø£ÙŠØ§Ù… Ù…ØªØªØ§Ù„ÙŠØ©</div>
        </div>
        
        <div class="compact-calendar">
          <div class="circle-calendar" id="calendarCircles"></div>
          
          <div class="calendar-progress">
            <div class="progress-bar">
              <div class="progress-fill" style="width: 0%"></div>
            </div>
            <div class="progress-text"><span class="english-numbers">0</span>/7 Ø£ÙŠØ§Ù… Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</div>
          </div>
        </div>
        
        <button class="checkin-button" id="checkinButton">
          <i class="fas fa-check-circle"></i>
          <span>Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ø§Ù„ÙŠÙˆÙ…</span>
        </button>
      </div>

      <div class="daily-tasks-card">
        <h3><i class="fas fa-tasks"></i> Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h3>
        <div class="tasks-list" id="tasksList"></div>
      </div>

      <div class="achievements-card">
        <h3><i class="fas fa-trophy"></i> Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²Ø§Øª</h3>
        <div class="achievements-grid" id="achievementsGrid"></div>
      </div>

      <div class="leaderboard-card">
        <h3><i class="fas fa-crown"></i> Ù„ÙˆØ­Ø© Ø§Ù„ØµØ¯Ø§Ø±Ø©</h3>
        <div class="leaderboard-tabs">
          <div class="leaderboard-tab active" data-period="daily">Ø§Ù„ÙŠÙˆÙ…</div>
          <div class="leaderboard-tab" data-period="weekly">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</div>
          <div class="leaderboard-tab" data-period="all">Ø§Ù„ÙƒÙ„</div>
        </div>
        <div class="leaderboard-list" id="leaderboardList"></div>
      </div>
    </div>

    <div class="section-hidden" id="sectionFriends">
      <div class="friends-card">
        <h3><i class="fas fa-user-friends"></i> Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡</h3>
        <div class="friends-list" id="friendsList"></div>
      </div>

      <div class="gifts-card">
        <h3><i class="fas fa-gift"></i> Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ Ø§Ù„Ù…ØªØ§Ø­Ø©</h3>
        <div class="gifts-list" id="giftsList"></div>
      </div>

      <div class="advanced-referral-card" id="advancedReferralCard">
        <h3><i class="fas fa-user-plus"></i> Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</h3>
        
        <div class="referral-link-container">
          <div class="referral-link-header">
            <div class="referral-link-title">
              <span>Ø±Ø§Ø¨Ø· Ø¯Ø¹ÙˆØªÙƒ Ø§Ù„Ø®Ø§Øµ</span>
              <span style="margin-right: 10px; color: var(--success); font-weight: bold; font-size: 12px;">
                <i class="fas fa-coins"></i> +100 Ù†Ù‚Ø·Ø© Ù„ÙƒÙ„ ØµØ¯ÙŠÙ‚
              </span>
            </div>
            <button class="copy-referral-btn" id="copyFriendReferralLink">
              <i class="fas fa-copy"></i> Ù†Ø³Ø®
            </button>
          </div>
          <div class="referral-link-value" id="friendReferralLink">
            Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...
          </div>
          <div class="referral-info-text">
            <i class="fas fa-info-circle"></i> Ø´Ø§Ø±Ùƒ Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ø¹ Ø£ØµØ¯Ù‚Ø§Ø¦Ùƒ ÙˆØ§Ø­ØµÙ„ Ø¹Ù„Ù‰ 100 Ù†Ù‚Ø·Ø© Ù„ÙƒÙ„ ØµØ¯ÙŠÙ‚ ÙŠØ¯Ø®Ù„ Ø¹Ø¨Ø± Ø±Ø§Ø¨Ø·Ùƒ!
          </div>
        </div>
        
        <div class="referral-stats-grid">
          <div class="referral-stat-card">
            <div class="referral-stat-value" id="totalFriendReferrals">0</div>
            <div class="referral-stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ÙØ­Ø§Ù„ÙŠÙ†</div>
          </div>
          <div class="referral-stat-card">
            <div class="referral-stat-value" id="referralEarnings">0</div>
            <div class="referral-stat-label">Ù†Ù‚Ø§Ø· Ù…ÙƒØªØ³Ø¨Ø©</div>
          </div>
        </div>
      </div>
    </div>

    <div class="section-hidden" id="sectionChallenges">
      <div class="challenges-card">
        <h3><i class="fas fa-bolt"></i> Ø§Ù„ØªØ­Ø¯ÙŠØ§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</h3>
        <div class="challenges-list" id="challengesList"></div>
      </div>
      
      <div class="challenges-card">
        <h3><i class="fas fa-users"></i> ØªØ­Ø¯ÙŠØ§Øª Ù…Ø¹ Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡</h3>
        <div class="friends-challenges" id="friendsChallenges"></div>
      </div>
      
      <div class="leaderboard-card">
        <h3><i class="fas fa-crown"></i> Ù„ÙˆØ­Ø© Ø§Ù„ØµØ¯Ø§Ø±Ø©</h3>
        <div class="leaderboard-tabs">
          <div class="leaderboard-tab active" data-period="daily">Ø§Ù„ÙŠÙˆÙ…</div>
          <div class="leaderboard-tab" data-period="weekly">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</div>
          <div class="leaderboard-tab" data-period="all">Ø§Ù„ÙƒÙ„</div>
        </div>
        <div class="leaderboard-list" id="leaderboardList"></div>
      </div>
    </div>

    <div class="section-hidden" id="sectionGroups">
      <div class="groups-card">
        <h3><i class="fas fa-users"></i> Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª ÙˆØ§Ù„Ø¹ØµØ§Ø¨Ø§Øª</h3>
        <div class="groups-list" id="groupsList"></div>
        <div style="text-align: center; margin-top: 15px;">
          <button class="challenge-action" id="createGroupBtn" style="width: 100%;">
            <i class="fas fa-plus"></i> Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©
          </button>
        </div>
      </div>
    </div>

    <div class="section-hidden" id="sectionReferrals">
      <div class="referrals-card">
        <h3><i class="fas fa-user-plus"></i> Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª</h3>
        <div class="referral-link">
          <input type="text" id="referralLink" value="Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„..." readonly>
          <button id="copyReferralLink">
            <i class="fas fa-copy"></i> Ù†Ø³Ø®
          </button>
        </div>
        <div class="referral-stats">
          <div class="referral-stat">
            <div class="value" id="totalReferrals">0</div>
            <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª</div>
          </div>
          <div class="referral-stat">
            <div class="value" id="activeReferrals">0</div>
            <div class="label">Ø¥Ø­Ø§Ù„Ø§Øª Ù†Ø´Ø·Ø©</div>
          </div>
          <div class="referral-stat">
            <div class="value" id="referralPoints">0</div>
            <div class="label">Ù†Ù‚Ø§Ø· Ø§Ù„Ø¥Ø­Ø§Ù„Ø©</div>
          </div>
          <div class="referral-stat">
            <div class="value" id="referralRewards">0</div>
            <div class="label">Ù…ÙƒØ§ÙØ¢Øª Ù…Ø³ØªØ­Ù‚Ø©</div>
          </div>
        </div>
        <h4 style="margin: 15px 0 10px 0;"><i class="fas fa-award"></i> Ù…ÙƒØ§ÙØ¢Øª Ø§Ù„Ø¥Ø­Ø§Ù„Ø©</h4>
        <div class="referral-rewards" id="referralRewardsList"></div>
      </div>
    </div>

    <div class="section-hidden" id="sectionShop">
      <div class="shop-card">
        <h3><i class="fas fa-store"></i> Ù…ØªØ¬Ø± Ø§Ù„Ù…ÙƒØ§ÙØ¢Øª</h3>
        <div class="shop-tabs" style="display: flex; margin-bottom: 15px; background: var(--bg-lighter); border-radius: 12px; padding: 4px;">
          <div class="leaderboard-tab active" data-category="all">Ø§Ù„ÙƒÙ„</div>
          <div class="leaderboard-tab" data-category="digital">Ø±Ù‚Ù…ÙŠ</div>
          <div class="leaderboard-tab" data-category="physical">Ù…Ù„Ù…ÙˆØ³</div>
          <div class="leaderboard-tab" data-category="discounts">Ø®ØµÙˆÙ…Ø§Øª</div>
        </div>
        <div class="shop-items" id="shopItems"></div>
      </div>
    </div>
  </div>

  <div class="bottom-nav" style="display: none;">
    <div class="nav-item active" id="navHome">
      <i class="fas fa-home"></i>
      <span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
    </div>
    <div class="nav-item" id="navFriends">
      <i class="fas fa-user-friends"></i>
      <span>Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡</span>
    </div>
    <div class="nav-item" id="navChallenges">
      <i class="fas fa-bolt"></i>
      <span>Ø§Ù„ØªØ­Ø¯ÙŠØ§Øª</span>
    </div>
    <div class="nav-item" id="navGroups">
      <i class="fas fa-users"></i>
      <span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª</span>
    </div>
    <div class="nav-item" id="navShop">
      <i class="fas fa-store"></i>
      <span>Ø§Ù„Ù…ØªØ¬Ø±</span>
    </div>
  </div>

  <div id="floatingMessage" class="floating-message" style="display: none;"></div>

  <script>
    // ========== ØªÙ‡ÙŠØ¦Ø© Firebase ==========
    const firebaseConfig = {
      apiKey: "AIzaSyBX8v0qIVjG-Z46fVDeEUDKcPxa_FQF9Qc",
      authDomain: "bnak-belaiba.firebaseapp.com",
      projectId: "bnak-belaiba",
      storageBucket: "bnak-belaiba.firebasestorage.app",
      messagingSenderId: "286736432059",
      appId: "1:286736432059:web:ec1ed4292850f00008229e",
      databaseURL: "https://bnak-belaiba-default-rtdb.firebaseio.com/"
    };

    let firebaseApp, auth, database, db;
    try {
      firebaseApp = firebase.initializeApp(firebaseConfig);
      auth = firebase.auth();
      database = firebase.database();
      db = firebase.firestore();
      console.log('âœ… Firebase ØªÙ… ØªÙ‡ÙŠØ¦ØªÙ‡ Ø¨Ù†Ø¬Ø§Ø­');
      updateFirebaseStatus('success', 'âœ… ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…');
    } catch (error) {
      console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Firebase:', error);
      updateFirebaseStatus('error', 'âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…');
    }

    // ========== Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ==========
    function updateFirebaseStatus(type, message) {
      const statusElement = document.getElementById('firebaseStatus');
      if (statusElement) {
        statusElement.textContent = message;
        statusElement.className = 'firebase-status';
        
        if (type === 'error') {
          statusElement.classList.add('error');
        } else if (type === 'warning') {
          statusElement.classList.add('warning');
        } else if (type === 'success') {
          statusElement.classList.add('success');
        }
        
        statusElement.style.display = 'block';
        
        setTimeout(() => {
          statusElement.style.display = 'none';
        }, 5000);
      }
    }

    function showLoading() {
      document.getElementById('loadingScreen').style.display = 'flex';
    }
    
    function hideLoading() {
      document.getElementById('loadingScreen').style.display = 'none';
    }

    function showMessage(text) {
      const messageEl = document.getElementById('floatingMessage');
      messageEl.textContent = text;
      messageEl.style.display = 'block';
      
      setTimeout(() => {
        messageEl.style.display = 'none';
      }, 2500);
    }

    function animatePoints(points) {
      const pointsEl = document.createElement('div');
      pointsEl.className = 'points-animation';
      pointsEl.textContent = `+${points.toLocaleString('en-US')} Ù†Ù‚Ø·Ø©`;
      pointsEl.style.position = 'fixed';
      pointsEl.style.top = '50%';
      pointsEl.style.left = '50%';
      pointsEl.style.transform = 'translate(-50%, -50%)';
      pointsEl.style.color = 'var(--success)';
      pointsEl.style.fontWeight = 'bold';
      pointsEl.style.fontSize = '24px';
      pointsEl.style.zIndex = '1000';
      pointsEl.style.pointerEvents = 'none';
      
      document.body.appendChild(pointsEl);
      
      setTimeout(() => {
        document.body.removeChild(pointsEl);
      }, 1000);
    }

    // ========== Ø¯ÙˆØ§Ù„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¨Ø³Ø·Ø© ==========
    async function registerUserIfNeeded(userData) {
      try {
        if (!db) {
          console.warn('âš ï¸ Firestore ØºÙŠØ± Ù…ØªØµÙ„ØŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ© ÙÙ‚Ø·');
          return null;
        }
        
        const userId = userData.id.toString();
        const usersRef = db.collection('users').doc(userId);
        
        const userDoc = await usersRef.get();
        
        if (!userDoc.exists) {
          const newUserData = {
            telegramId: userId,
            firstName: userData.first_name || userData.firstName || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ',
            username: userData.username || null,
            totalPoints: 100,
            currentStreak: 0,
            lastCheckinDate: null,
            referrals: 0,
            referralPoints: 0,
            registrationDate: firebase.firestore.FieldValue.serverTimestamp(),
            lastLogin: firebase.firestore.FieldValue.serverTimestamp()
          };
          
          await usersRef.set(newUserData);
          console.log('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', userId);
          
          return newUserData;
        } else {
          await usersRef.update({
            lastLogin: firebase.firestore.FieldValue.serverTimestamp()
          });
          
          const existingUser = userDoc.data();
          console.log('ğŸ‘¤ ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯:', userId);
          return existingUser;
        }
      } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', error);
        throw error;
      }
    }

    async function updateUserPoints(userId, pointsChange, reason) {
      try {
        if (!db) return false;
        
        const userRef = db.collection('users').doc(userId);
        
        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        const userDoc = await userRef.get();
        if (!userDoc.exists) {
          console.error('âŒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
          return false;
        }
        
        const userData = userDoc.data();
        const currentPoints = userData.totalPoints || 0;
        const newPoints = currentPoints + pointsChange;
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ù‚Ø§Ø· ÙÙ‚Ø·
        await userRef.update({
          totalPoints: newPoints,
          lastLogin: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ÙÙŠ Ø³Ø¬Ù„ Ø§Ù„Ù†Ù‚Ø§Ø·
        await db.collection('pointsHistory').add({
          userId: userId,
          pointsChange: pointsChange,
          pointsAfter: newPoints,
          reason: reason,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        console.log(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ù‚Ø§Ø· Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ${userId}: ${currentPoints} â†’ ${newPoints} (${reason})`);
        return true;
      } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ù‚Ø§Ø·:', error);
        return false;
      }
    }

    async function updateUserStreak(userId, newStreak, lastCheckinDate) {
      try {
        if (!db) return false;
        
        const userRef = db.collection('users').doc(userId);
        
        await userRef.update({
          currentStreak: newStreak,
          lastCheckinDate: lastCheckinDate,
          lastLogin: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        console.log(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØªØ§Ø¨Ø¹ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ${userId}: ${newStreak} Ø£ÙŠØ§Ù…`);
        return true;
      } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØªØ§Ø¨Ø¹:', error);
        return false;
      }
    }

    async function addReferralToDatabase(referrerId, referredId) {
      try {
        if (!db) return false;
        
        const referralRef = db.collection('referrals').doc();
        const referralDate = new Date().toISOString().split('T')[0];
        const pointsAwarded = 100;
        
        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¥Ø­Ø§Ù„Ø©
        await referralRef.set({
          referrerId: referrerId,
          referredId: referredId,
          referralDate: referralDate,
          pointsAwarded: pointsAwarded,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ÙØ­ÙŠÙ„
        const referrerRef = db.collection('users').doc(referrerId);
        await referrerRef.update({
          referrals: firebase.firestore.FieldValue.increment(1),
          referralPoints: firebase.firestore.FieldValue.increment(pointsAwarded),
          totalPoints: firebase.firestore.FieldValue.increment(pointsAwarded)
        });
        
        // ØªØ³Ø¬ÙŠÙ„ Ù†Ù‚Ø§Ø· Ø§Ù„Ø¥Ø­Ø§Ù„Ø© ÙÙŠ Ø³Ø¬Ù„ Ø§Ù„Ù†Ù‚Ø§Ø·
        await db.collection('pointsHistory').add({
          userId: referrerId,
          pointsChange: pointsAwarded,
          reason: 'Ù…ÙƒØ§ÙØ£Ø© Ø¥Ø­Ø§Ù„Ø©',
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        console.log(`âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¥Ø­Ø§Ù„Ø© Ù…Ù† ${referrerId} Ø¥Ù„Ù‰ ${referredId}`);
        return true;
      } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¥Ø­Ø§Ù„Ø©:', error);
        return false;
      }
    }

    async function getUserStatsFromDatabase(userId) {
      try {
        if (!db) return null;
        
        const userRef = db.collection('users').doc(userId);
        const userDoc = await userRef.get();
        
        if (!userDoc.exists) {
          return null;
        }
        
        const userData = userDoc.data();
        
        // Ø¬Ù„Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª
        const referralsSnapshot = await db.collection('referrals')
          .where('referrerId', '==', userId)
          .get();
        
        return {
          totalPoints: userData.totalPoints || 0,
          currentStreak: userData.currentStreak || 0,
          lastCheckinDate: userData.lastCheckinDate || null,
          referrals: referralsSnapshot.size || 0,
          referralPoints: userData.referralPoints || 0
        };
      } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', error);
        return null;
      }
    }

    async function getLeaderboardFromDatabase() {
      try {
        if (!db) return [];
        
        const usersSnapshot = await db.collection('users')
          .orderBy('totalPoints', 'desc')
          .limit(50)
          .get();
        
        const leaderboard = [];
        usersSnapshot.forEach(doc => {
          const user = doc.data();
          leaderboard.push({
            id: doc.id,
            name: user.firstName || 'Ù…Ø³ØªØ®Ø¯Ù…',
            points: user.totalPoints || 0,
            avatar: (user.firstName || 'Ù…').charAt(0),
            level: calculateLevel(user.totalPoints || 0)
          });
        });
        
        return leaderboard;
      } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ù„ÙˆØ­Ø© Ø§Ù„ØµØ¯Ø§Ø±Ø©:', error);
        return [];
      }
    }

    // ========== Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ© ==========
    const gameData = {
      user: null,
      dailyTasks: [
        { id: 1, title: "Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ø§Ù„ÙŠÙˆÙ…", description: "Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ù†Ù‚Ø§Ø· Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙŠÙˆÙ…ÙŠ", icon: "fas fa-calendar-check", reward: 50, completed: false, type: "checkin" },
        { id: 2, title: "Ø´Ø§Ø±Ùƒ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚", description: "Ø´Ø§Ø±Ùƒ Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ø¹ 3 Ø£ØµØ¯Ù‚Ø§Ø¡", icon: "fas fa-share-alt", reward: 100, completed: false, type: "share" },
        { id: 3, title: "Ø£ÙƒÙ…Ù„ Ù…Ù„ÙÙƒ Ø§Ù„Ø´Ø®ØµÙŠ", description: "Ø£Ø¶Ù ØµÙˆØ±Ø© ÙˆØ¨ÙŠØ§Ù†Ø§ØªÙƒ", icon: "fas fa-user-edit", reward: 75, completed: false, type: "profile" },
        { id: 4, title: "ØªÙÙ‚Ø¯ Ø§Ù„ØµØ¯Ø§Ø±Ø©", description: "ØªÙÙ‚Ø¯ Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†", icon: "fas fa-crown", reward: 30, completed: false, type: "leaderboard" },
        { id: 5, title: "Ø£Ø±Ø³Ù„ Ù‡Ø¯ÙŠØ©", description: "Ø£Ø±Ø³Ù„ Ù‡Ø¯ÙŠØ© Ù„ØµØ¯ÙŠÙ‚", icon: "fas fa-gift", reward: 80, completed: false, type: "gift" }
      ],
      
      achievements: [
        { id: 1, title: "Ø§Ù„Ù…Ø¨ØªØ¯Ø¦", description: "Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„ Ù…Ø±Ø©", icon: "fas fa-star", reward: 100, unlocked: false },
        { id: 2, title: "Ù…Ø¯Ø§ÙˆÙ…", description: "Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ 7 Ø£ÙŠØ§Ù… Ù…ØªØªØ§Ù„ÙŠØ©", icon: "fas fa-fire", reward: 300, unlocked: false },
        { id: 3, title: "Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ", description: "Ø§Ø¯Ø¹Ùˆ 5 Ø£ØµØ¯Ù‚Ø§Ø¡", icon: "fas fa-users", reward: 500, unlocked: false },
        { id: 4, title: "Ø§Ù„Ø«Ø±Ø§Ø¡", description: "Ø§Ø¬Ù…Ø¹ 5000 Ù†Ù‚Ø·Ø©", icon: "fas fa-gem", reward: 1000, unlocked: false },
        { id: 5, title: "Ø§Ù„Ø¨Ø·Ù„", description: "ØªØµØ¯Ø± Ù„ÙˆØ­Ø© Ø§Ù„ØµØ¯Ø§Ø±Ø©", icon: "fas fa-trophy", reward: 2000, unlocked: false }
      ],
      
      leaderboard: {
        daily: [],
        weekly: [],
        all: []
      },

      friends: [],
      gifts: [
        { id: 1, title: "Ù‡Ø¯ÙŠØ© Ø§Ù„ØªØ±Ø­ÙŠØ¨", description: "50 Ù†Ù‚Ø·Ø© ØªØ±Ø­ÙŠØ¨ÙŠØ©", icon: "fas fa-gift", points: 50, sendable: true },
        { id: 2, title: "Ù‡Ø¯ÙŠØ© Ø§Ù„ØµØ¯Ø§Ù‚Ø©", description: "Ù…Ø¶Ø§Ø¹ÙØ© Ø§Ù„Ù†Ù‚Ø§Ø· Ù„ÙŠÙˆÙ… ÙƒØ§Ù…Ù„", icon: "fas fa-heart", points: 100, sendable: true },
        { id: 3, title: "Ù‡Ø¯ÙŠØ© Ø§Ù„ØªØ­Ø¯ÙŠ", description: "ØªØ­Ø¯ÙŠ Ø®Ø§Øµ Ù…Ø¹ ØµØ¯ÙŠÙ‚", icon: "fas fa-trophy", points: 150, sendable: true }
      ],

      challenges: [
        { id: 1, title: "ØªØ­Ø¯ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„", description: "Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ 5 Ø£ÙŠØ§Ù… Ù…ØªØªØ§Ù„ÙŠØ©", icon: "fas fa-calendar", reward: 200, type: "daily", timeLeft: "2 ÙŠÙˆÙ…" },
        { id: 2, title: "ØªØ­Ø¯ÙŠ Ø§Ù„Ù†Ù‚Ø§Ø·", description: "Ø§Ø¬Ù…Ø¹ 1000 Ù†Ù‚Ø·Ø© ÙÙŠ Ø£Ø³Ø¨ÙˆØ¹", icon: "fas fa-coins", reward: 500, type: "weekly", timeLeft: "5 Ø£ÙŠØ§Ù…" },
        { id: 3, title: "ØªØ­Ø¯ÙŠ Ø§Ù„ØµØ¯Ø§Ù‚Ø©", description: "Ø§Ø±Ø³Ù„ Ù‡Ø¯Ø§ÙŠØ§ Ù„Ù€ 3 Ø£ØµØ¯Ù‚Ø§Ø¡", icon: "fas fa-user-friends", reward: 300, type: "daily", timeLeft: "1 ÙŠÙˆÙ…" }
      ],

      friendChallenges: [],
      groups: [],

      referrals: {
        total: 0,
        active: 0,
        points: 0,
        rewards: 0,
        rewardsList: [
          { id: 1, title: "3 Ø¥Ø­Ø§Ù„Ø§Øª", description: "Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ 300 Ù†Ù‚Ø·Ø©", reward: 300, achieved: false },
          { id: 2, title: "5 Ø¥Ø­Ø§Ù„Ø§Øª", description: "Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ 500 Ù†Ù‚Ø·Ø©", reward: 500, achieved: false },
          { id: 3, title: "10 Ø¥Ø­Ø§Ù„Ø§Øª", description: "Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ù‡Ø¯ÙŠØ© Ù…Ù…ÙŠØ²Ø©", reward: "Ù‡Ø¯ÙŠØ© Ù…Ù…ÙŠØ²Ø©", achieved: false },
          { id: 4, title: "20 Ø¥Ø­Ø§Ù„Ø©", description: "Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ 2000 Ù†Ù‚Ø·Ø©", reward: 2000, achieved: false }
        ]
      },

      shopItems: [
        { id: 1, title: "Ù‚Ø³ÙŠÙ…Ø© Ø£Ù…Ø§Ø²ÙˆÙ† 50 Ø±ÙŠØ§Ù„", description: "Ù‚Ø³ÙŠÙ…Ø© Ø´Ø±Ø§Ø¡ Ù…Ù† Ø£Ù…Ø§Ø²ÙˆÙ†", icon: "fas fa-shopping-cart", points: 5000, category: "physical" },
        { id: 2, title: "Ø§Ø´ØªØ±Ø§Ùƒ Ø³ØªÙˆØ±Ù‰ 3 Ø£Ø´Ù‡Ø±", description: "Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ ØªØ·Ø¨ÙŠÙ‚ Ø³ØªÙˆØ±Ù‰", icon: "fas fa-film", points: 3000, category: "digital" },
        { id: 3, title: "Ø®ØµÙ… 20% Ø¹Ù„Ù‰ Ù†ÙˆÙ†", description: "Ø®ØµÙ… Ø¹Ù„Ù‰ Ù…Ø´ØªØ±ÙŠØ§Øª Ù†ÙˆÙ†", icon: "fas fa-tag", points: 1500, category: "discounts" },
        { id: 4, title: "Ø¨Ø·Ø§Ù‚Ø© Ø¢ÙŠØªÙˆÙ†Ø² 100 Ø±ÙŠØ§Ù„", description: "Ø¨Ø·Ø§Ù‚Ø© Ø´Ø­Ù† Ø¢ÙŠØªÙˆÙ†Ø²", icon: "fas fa-music", points: 2500, category: "digital" },
        { id: 5, title: "ØªØ°ÙƒØ±Ø© Ø³ÙŠÙ†Ù…Ø§", description: "ØªØ°ÙƒØ±Ø© Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© ÙÙŠÙ„Ù…", icon: "fas fa-ticket-alt", points: 800, category: "physical" }
      ]
    };

    let currentUser = null;

    function calculateLevel(points) {
      if (points <= 0) return 1;
      if (points >= 5000000) return 100;
      
      const level = Math.floor(100 * Math.pow(points / 5000000, 1/2.8));
      return Math.max(1, Math.min(99, level));
    }

    async function loadUserData() {
      try {
        if (!currentUser || !currentUser.id) {
          throw new Error("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„");
        }
        
        // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙ‚Ø· (Ø§Ù„Ù†Ù‚Ø§Ø·ØŒ Ø§Ù„ØªØªØ§Ø¨Ø¹ØŒ Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª)
        const dbStats = await getUserStatsFromDatabase(currentUser.id);
        
        if (dbStats) {
          // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
          gameData.user = {
            id: currentUser.id,
            telegramId: currentUser.id,
            name: currentUser.firstName || 'Ù…Ø³ØªØ®Ø¯Ù…',
            points: dbStats.totalPoints || 100,
            level: calculateLevel(dbStats.totalPoints || 100),
            streak: dbStats.currentStreak || 0,
            lastCheckin: dbStats.lastCheckinDate || null,
            avatar: (currentUser.firstName || 'Ù…').charAt(0),
            referrals: dbStats.referrals || 0,
            referralPoints: dbStats.referralPoints || 0
          };
        } else {
          // Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
          gameData.user = {
            id: currentUser.id,
            telegramId: currentUser.id,
            name: currentUser.firstName || 'Ù…Ø³ØªØ®Ø¯Ù…',
            points: 100,
            level: 1,
            streak: 0,
            lastCheckin: null,
            avatar: (currentUser.firstName || 'Ù…').charAt(0),
            referrals: 0,
            referralPoints: 0
          };
        }
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© (Ø§Ù„Ù…Ù‡Ø§Ù…ØŒ Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²Ø§ØªØŒ Ø¥Ù„Ø®) Ù…Ù† localStorage
        loadLocalGameData();
        
        console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…');
        return true;
      } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', error);
        return loadLocalUserData();
      }
    }

    function loadLocalGameData() {
      try {
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ù…Ù† localStorage
        const savedData = localStorage.getItem(`crynova_local_data_${currentUser.id}`);
        if (savedData) {
          const localData = JSON.parse(savedData);
          
          // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
          if (localData.dailyTasks) {
            gameData.user.dailyTasks = localData.dailyTasks;
          }
          if (localData.achievements) {
            gameData.user.achievements = localData.achievements;
          }
          if (localData.friends) {
            gameData.friends = localData.friends;
          }
          if (localData.challenges) {
            gameData.challenges = localData.challenges;
          }
          if (localData.groups) {
            gameData.groups = localData.groups;
          }
        } else {
          // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
          gameData.user.dailyTasks = gameData.dailyTasks.map(task => ({ ...task, completed: false }));
          gameData.user.achievements = gameData.achievements.map(ach => ({ ...ach, unlocked: false }));
        }
      } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©:', error);
      }
    }

    function saveLocalGameData() {
      try {
        // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© ÙÙŠ localStorage
        const localData = {
          dailyTasks: gameData.user.dailyTasks || [],
          achievements: gameData.user.achievements || [],
          friends: gameData.friends || [],
          challenges: gameData.challenges || [],
          groups: gameData.groups || []
        };
        
        localStorage.setItem(`crynova_local_data_${currentUser.id}`, JSON.stringify(localData));
        console.log('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©');
        return true;
      } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©:', error);
        return false;
      }
    }

    function loadLocalUserData() {
      const userId = currentUser?.id || 'local_' + Date.now();
      const userName = currentUser?.firstName || 'Ù…Ø³ØªØ®Ø¯Ù…';
      
      gameData.user = {
        id: userId,
        telegramId: userId,
        name: userName,
        points: 100,
        level: 1,
        streak: 0,
        lastCheckin: null,
        avatar: userName.charAt(0),
        referrals: 0,
        referralPoints: 0,
        dailyTasks: gameData.dailyTasks.map(task => ({ ...task, completed: false })),
        achievements: gameData.achievements.map(ach => ({ ...ach, unlocked: false }))
      };
      
      console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…');
      return true;
    }

    async function loadAdditionalData() {
      try {
        console.log('ğŸ”„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©...');
        
        // ØªØ­Ù…ÙŠÙ„ Ù„ÙˆØ­Ø© Ø§Ù„ØµØ¯Ø§Ø±Ø© Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        gameData.leaderboard.all = await getLeaderboardFromDatabase();
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        loadLocalGameData();
        
        // Ø¹Ø±Ø¶ ÙƒÙ„ Ø´ÙŠØ¡
        renderDailyTasks();
        renderAchievements();
        renderLeaderboard('all');
        renderFriendsAndGifts();
        renderChallenges();
        renderGroups();
        renderReferrals();
        renderShopItems();
        
        console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©');
      } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©:', error);
      }
    }

    // ========== Ø¯Ø§Ù„Ø§Øª Ø§Ù„Ø¹Ø±Ø¶ ==========
    function renderCheckinCalendar() {
      const daysOfWeek = ['Ø£', 'Ø¥', 'Ø«', 'Ø£', 'Ø®', 'Ø¬', 'Ø³'];
      const today = new Date();
      const currentDay = today.getDay();
      
      const calendarEl = document.getElementById('calendarCircles');
      calendarEl.innerHTML = '';
      
      const lastCheckin = gameData.user.lastCheckin;
      const lastCheckinDate = lastCheckin ? new Date(lastCheckin) : null;
      const startOfWeek = new Date(today);
      startOfWeek.setDate(today.getDate() - currentDay);
      
      let checkedDays = 0;
      
      for (let i = 0; i < 7; i++) {
        const dayDate = new Date(startOfWeek);
        dayDate.setDate(startOfWeek.getDate() + i);
        
        const isToday = i === currentDay;
        const isPast = i < currentDay;
        const isChecked = lastCheckinDate && 
                         lastCheckinDate.toDateString() === dayDate.toDateString();
        
        if (isChecked) checkedDays++;
        
        const dayEl = document.createElement('div');
        dayEl.className = 'calendar-circle';
        if (isChecked) dayEl.classList.add('checked');
        if (isToday) dayEl.classList.add('today');
        if (!isPast && !isToday) dayEl.classList.add('future');
        if (i === 6) dayEl.classList.add('special');
        
        dayEl.title = `${['Ø§Ù„Ø£Ø­Ø¯', 'Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†', 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡', 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡', 'Ø§Ù„Ø®Ù…ÙŠØ³', 'Ø§Ù„Ø¬Ù…Ø¹Ø©', 'Ø§Ù„Ø³Ø¨Øª'][i]} - ${50 + (i * 10)} Ù†Ù‚Ø·Ø©${i === 6 ? ' (Ù…Ø¶Ø§Ø¹ÙØ©)' : ''}`;
        
        if (isChecked) {
          dayEl.innerHTML = '<div class="circle-check">âœ“</div>';
        } else if (isToday) {
          dayEl.innerHTML = '<div class="circle-today">!</div>';
        } else {
          dayEl.innerHTML = `<div class="circle-day">${daysOfWeek[i]}</div>`;
        }
        
        if (i === 6) {
          dayEl.innerHTML += '<div class="circle-bonus">Ã—2</div>';
        }
        
        calendarEl.appendChild(dayEl);
      }
      
      const progressPercent = (checkedDays / 7) * 100;
      document.querySelector('.progress-fill').style.width = `${progressPercent}%`;
      document.querySelector('.progress-text').innerHTML = `<span class="english-numbers">${checkedDays}</span>/7 Ø£ÙŠØ§Ù… Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹`;
    }

    function checkDailyCheckin() {
      if (!gameData.user) return;
      
      const today = new Date().toDateString();
      const lastCheckin = gameData.user.lastCheckin;
      const checkinButton = document.getElementById('checkinButton');
      
      if (lastCheckin === today) {
        checkinButton.disabled = true;
        checkinButton.classList.add('checked');
        checkinButton.innerHTML = '<i class="fas fa-check-circle"></i><span>ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙŠÙˆÙ…</span>';
      } else {
        checkinButton.disabled = false;
        checkinButton.classList.remove('checked');
      }
    }

    function renderDailyTasks() {
      if (!gameData.user || !gameData.user.dailyTasks) {
        gameData.user.dailyTasks = gameData.dailyTasks.map(task => ({ ...task, completed: false }));
      }
      
      const tasksListEl = document.getElementById('tasksList');
      tasksListEl.innerHTML = '';
      
      gameData.user.dailyTasks.forEach(task => {
        const taskEl = document.createElement('div');
        taskEl.className = `task-item ${task.completed ? 'completed' : ''}`;
        
        taskEl.innerHTML = `
          <div class="task-info">
            <div class="task-icon">
              <i class="${task.icon}"></i>
            </div>
            <div class="task-details">
              <h4>${task.title}</h4>
              <p>${task.description}</p>
            </div>
          </div>
          <button class="task-action ${task.completed ? 'completed' : ''}" data-task-id="${task.id}" ${task.completed ? 'disabled' : ''}>
            ${task.completed ? '<i class="fas fa-check"></i>' : `<span class="english-numbers">+${task.reward}</span>`}
          </button>
        `;
        
        tasksListEl.appendChild(taskEl);
      });
    }

    function renderAchievements() {
      if (!gameData.user || !gameData.user.achievements) {
        gameData.user.achievements = gameData.achievements.map(ach => ({ ...ach, unlocked: false }));
      }
      
      const achievementsGridEl = document.getElementById('achievementsGrid');
      achievementsGridEl.innerHTML = '';
      
      gameData.user.achievements.forEach(achievement => {
        const achievementEl = document.createElement('div');
        achievementEl.className = `achievement-item ${achievement.unlocked ? '' : 'locked'}`;
        
        achievementEl.innerHTML = `
          <div class="achievement-icon">
            <i class="${achievement.icon}"></i>
          </div>
          <h4>${achievement.title}</h4>
          <p>${achievement.description}</p>
          <div class="achievement-reward"><span class="english-numbers">+${achievement.reward}</span> Ù†Ù‚Ø·Ø©</div>
        `;
        
        achievementsGridEl.appendChild(achievementEl);
      });
    }

    async function renderLeaderboard(period) {
      const leaderboardListEl = document.getElementById('leaderboardList');
      leaderboardListEl.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-light)">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';
      
      // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      const players = await getLeaderboardFromDatabase();
      
      leaderboardListEl.innerHTML = '';
      
      if (players.length === 0) {
        leaderboardListEl.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-light)">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯</div>';
        return;
      }
      
      players.forEach((player, index) => {
        const playerEl = document.createElement('div');
        playerEl.className = `leaderboard-item ${player.id === currentUser?.id ? 'me' : ''}`;
        
        const rankClass = index < 3 ? `top-${index + 1}` : '';
        
        playerEl.innerHTML = `
          <div class="leaderboard-rank ${rankClass} english-numbers">${index + 1}</div>
          <div class="leaderboard-user">
            <div class="leaderboard-avatar">${player.avatar}</div>
            <div>
              <div class="leaderboard-name">${player.name}</div>
              <div style="font-size: 12px; color: var(--text-light)">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ <span class="english-numbers">${player.level}</span></div>
            </div>
          </div>
          <div class="leaderboard-points english-numbers">${player.points.toLocaleString('en-US')}</div>
        `;
        
        leaderboardListEl.appendChild(playerEl);
      });
    }

    function renderFriendsAndGifts() {
      const friendsListEl = document.getElementById('friendsList');
      friendsListEl.innerHTML = '';
      
      if (gameData.friends.length === 0) {
        friendsListEl.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-light)">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ØµØ¯Ù‚Ø§Ø¡ Ø¨Ø¹Ø¯. Ø§Ø¯Ø¹Ù Ø£ØµØ¯Ù‚Ø§Ø¡Ùƒ!</div>';
      } else {
        gameData.friends.forEach(friend => {
          const friendEl = document.createElement('div');
          friendEl.className = 'friend-item';
          const friendLevel = calculateLevel(friend.points);
          
          friendEl.innerHTML = `
            <div class="friend-info">
              <div class="friend-avatar">${friend.avatar}</div>
              <div>
                <div class="friend-name">${friend.name}</div>
                <div class="friend-status ${friend.online ? 'online' : ''}">
                  ${friend.online ? 'ğŸŸ¢ Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù†' : 'âš« ØºÙŠØ± Ù…ØªØµÙ„'} â€¢ <span class="english-numbers">${friend.points.toLocaleString('en-US')}</span> Ù†Ù‚Ø·Ø©
                </div>
              </div>
            </div>
            <div>
              <button class="gift-action send-gift-btn" data-friend-id="${friend.id}">
                <i class="fas fa-gift"></i> Ø£Ø±Ø³Ù„ Ù‡Ø¯ÙŠØ©
              </button>
            </div>
          `;
          
          friendsListEl.appendChild(friendEl);
        });
      }
      
      const giftsListEl = document.getElementById('giftsList');
      giftsListEl.innerHTML = '';
      
      gameData.gifts.forEach(gift => {
        const giftEl = document.createElement('div');
        giftEl.className = 'gift-item';
        
        giftEl.innerHTML = `
          <div class="gift-info">
            <div class="gift-icon">
              <i class="${gift.icon}"></i>
            </div>
            <div class="gift-details">
              <h4>${gift.title}</h4>
              <p>${gift.description}</p>
            </div>
          </div>
          <div>
            <button class="gift-action ${gift.sendable ? '' : 'disabled'}" data-gift-id="${gift.id}" ${!gift.sendable ? 'disabled' : ''}>
              ${gift.sendable ? `Ø£Ø±Ø³Ù„ (<span class="english-numbers">+${gift.points}</span>)` : 'ØºÙŠØ± Ù…ØªØ§Ø­'}
            </button>
          </div>
        `;
        
        giftsListEl.appendChild(giftEl);
      });
    }

    function renderChallenges() {
      const challengesListEl = document.getElementById('challengesList');
      challengesListEl.innerHTML = '';
      
      gameData.challenges.forEach(challenge => {
        const challengeEl = document.createElement('div');
        challengeEl.className = 'challenge-item';
        
        challengeEl.innerHTML = `
          <div class="challenge-info">
            <div class="challenge-icon">
              <i class="${challenge.icon}"></i>
            </div>
            <div class="challenge-details">
              <h4>${challenge.title}</h4>
              <p>${challenge.description} â€¢ ${challenge.timeLeft} Ù…ØªØ¨Ù‚ÙŠ</p>
            </div>
          </div>
          <div>
            <button class="challenge-action" data-challenge-id="${challenge.id}">
              Ø§Ø¨Ø¯Ø£ (<span class="english-numbers">+${challenge.reward}</span>)
            </button>
          </div>
        `;
        
        challengesListEl.appendChild(challengeEl);
      });
    }

    function renderGroups() {
      const groupsListEl = document.getElementById('groupsList');
      groupsListEl.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-light)">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø¨Ø¹Ø¯. Ø£Ù†Ø´Ø¦ Ù…Ø¬Ù…ÙˆØ¹ØªÙƒ Ø§Ù„Ø£ÙˆÙ„Ù‰!</div>';
    }

    function renderReferrals() {
      if (!gameData.user) return;
      
      document.getElementById('totalReferrals').textContent = gameData.user.referrals || 0;
      document.getElementById('activeReferrals').textContent = gameData.user.referrals || 0;
      document.getElementById('referralPoints').textContent = (gameData.user.referralPoints || 0).toLocaleString('en-US');
      document.getElementById('referralRewards').textContent = gameData.referrals.rewards;
      
      const rewardsListEl = document.getElementById('referralRewardsList');
      rewardsListEl.innerHTML = '';
      
      const updatedRewards = gameData.referrals.rewardsList.map(reward => {
        const requiredReferrals = parseInt(reward.title.match(/\d+/)[0]);
        return {
          ...reward,
          achieved: (gameData.user.referrals || 0) >= requiredReferrals
        };
      });
      
      updatedRewards.forEach(reward => {
        const rewardEl = document.createElement('div');
        rewardEl.className = 'gift-item';
        
        const rewardText = typeof reward.reward === 'number' ? 
          `<span class="english-numbers">${reward.reward}</span> Ù†Ù‚Ø·Ø©` : 
          reward.reward;
        
        rewardEl.innerHTML = `
          <div class="gift-info">
            <div class="gift-icon" style="background: ${reward.achieved ? 'linear-gradient(135deg, var(--success), #1dd1a1)' : 'linear-gradient(135deg, #cccccc, #999999)'};">
              <i class="fas fa-award"></i>
            </div>
            <div class="gift-details">
              <h4>${reward.title}</h4>
              <p>${reward.description}</p>
            </div>
          </div>
          <div>
            <button class="gift-action ${reward.achieved ? 'completed' : ''}" data-reward-id="${reward.id}" ${!reward.achieved ? 'disabled' : ''}>
              ${reward.achieved ? 'Ø§Ø³ØªÙ„Ù…' : 'ØºÙŠØ± Ù…ÙØ¹Ù„'}
            </button>
          </div>
        `;
        
        rewardsListEl.appendChild(rewardEl);
      });
    }

    function renderShopItems(category = 'all') {
      const shopItemsEl = document.getElementById('shopItems');
      shopItemsEl.innerHTML = '';
      
      let filteredItems = gameData.shopItems;
      if (category !== 'all') {
        filteredItems = gameData.shopItems.filter(item => item.category === category);
      }
      
      if (filteredItems.length === 0) {
        shopItemsEl.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-light)">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…</div>';
        return;
      }
      
      filteredItems.forEach(item => {
        const itemEl = document.createElement('div');
        itemEl.className = 'shop-item';
        
        const canAfford = gameData.user.points >= item.points;
        
        itemEl.innerHTML = `
          <div class="shop-info">
            <div class="shop-icon">
              <i class="${item.icon}"></i>
            </div>
            <div class="shop-details">
              <h4>${item.title}</h4>
              <p>${item.description}</p>
              <div style="font-size: 12px; color: ${canAfford ? 'var(--success)' : 'var(--danger)'}; margin-top: 5px;">
                <span class="english-numbers">${item.points.toLocaleString('en-US')}</span> Ù†Ù‚Ø·Ø© ${!canAfford ? 'â€¢ Ù†Ù‚Ø§Ø· ØºÙŠØ± ÙƒØ§ÙÙŠØ©' : ''}
              </div>
            </div>
          </div>
          <div>
            <button class="shop-action ${canAfford ? '' : 'disabled'}" data-item-id="${item.id}" ${!canAfford ? 'disabled' : ''}>
              ${canAfford ? 'Ø§Ø´ØªØ±ÙŠ Ø§Ù„Ø¢Ù†' : 'Ù†Ù‚Ø§Ø· ØºÙŠØ± ÙƒØ§ÙÙŠØ©'}
            </button>
          </div>
        `;
        
        shopItemsEl.appendChild(itemEl);
      });
    }

    // ========== ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ==========
    function updateUserInfo() {
      if (!gameData.user) return;
      
      document.getElementById('userName').textContent = gameData.user.name || currentUser?.firstName || 'Ù…Ø³ØªØ®Ø¯Ù…';
      document.getElementById('userAvatar').textContent = gameData.user.avatar || (currentUser?.firstName?.charAt(0) || 'Ù…');
      document.getElementById('userLevel').textContent = gameData.user.level || 1;
      document.getElementById('totalPoints').textContent = (gameData.user.points || 0).toLocaleString('en-US');
      document.getElementById('streakBadge').innerHTML = `ğŸ”¥ <span class="english-numbers">${gameData.user.streak || 0}</span> Ø£ÙŠØ§Ù… Ù…ØªØªØ§Ù„ÙŠØ©`;
      
      // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØªØ­Øª Ø§Ù„Ø§Ø³Ù…
      const userUsernameEl = document.getElementById('userUsername');
      if (currentUser && currentUser.username) {
        userUsernameEl.textContent = `@${currentUser.username}`;
        userUsernameEl.style.display = 'block';
      } else {
        userUsernameEl.style.display = 'none';
      }
      
      // Ø±Ø§Ø¨Ø· Ø§Ù„Ø¥Ø­Ø§Ù„Ø©
      if (currentUser && currentUser.id) {
        document.getElementById('friendReferralLink').textContent = 
          `https://crynova.com/ref/${currentUser.id}`;
        document.getElementById('referralLink').value = 
          `https://crynova.com/ref/${currentUser.id}`;
      } else {
        const referralCode = gameData.user.telegramId || gameData.user.id || 'unknown';
        document.getElementById('friendReferralLink').textContent = 
          `https://crynova.com/ref/${referralCode}`;
        document.getElementById('referralLink').value = 
          `https://crynova.com/ref/${referralCode}`;
      }
      
      document.getElementById('totalFriendReferrals').textContent = gameData.user.referrals || 0;
      document.getElementById('referralEarnings').textContent = (gameData.user.referralPoints || 0).toLocaleString('en-US');
      document.getElementById('totalReferrals').textContent = gameData.user.referrals || 0;
      document.getElementById('referralPoints').textContent = (gameData.user.referralPoints || 0).toLocaleString('en-US');
    }

    // ========== Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« ==========
    function setupEventListeners() {
      document.getElementById('checkinButton').addEventListener('click', handleDailyCheckin);
      
      document.addEventListener('click', function(e) {
        if (e.target.closest('.task-action')) {
          const button = e.target.closest('.task-action');
          const taskId = parseInt(button.getAttribute('data-task-id'));
          completeTask(taskId);
        }
        
        if (e.target.closest('.send-gift-btn')) {
          const button = e.target.closest('.send-gift-btn');
          const friendId = button.getAttribute('data-friend-id');
          sendGiftToFriend(friendId);
        }
        
        if (e.target.closest('.gift-action') && e.target.closest('.gift-action').getAttribute('data-gift-id')) {
          const button = e.target.closest('.gift-action');
          const giftId = parseInt(button.getAttribute('data-gift-id'));
          sendGift(giftId);
        }
        
        if (e.target.closest('.challenge-action') && e.target.closest('.challenge-action').getAttribute('data-challenge-id')) {
          const button = e.target.closest('.challenge-action');
          const challengeId = parseInt(button.getAttribute('data-challenge-id'));
          startChallenge(challengeId);
        }
        
        if (e.target.closest('.shop-action')) {
          const button = e.target.closest('.shop-action');
          const itemId = parseInt(button.getAttribute('data-item-id'));
          purchaseItem(itemId);
        }
        
        if (e.target.closest('.gift-action') && e.target.closest('.gift-action').getAttribute('data-reward-id')) {
          const button = e.target.closest('.gift-action');
          const rewardId = parseInt(button.getAttribute('data-reward-id'));
          claimReferralReward(rewardId);
        }
      });
      
      document.querySelectorAll('.leaderboard-tab').forEach(tab => {
        tab.addEventListener('click', function() {
          document.querySelectorAll('.leaderboard-tab').forEach(t => t.classList.remove('active'));
          this.classList.add('active');
          
          const period = this.getAttribute('data-period');
          renderLeaderboard(period);
        });
      });
      
      document.querySelectorAll('.shop-tabs .leaderboard-tab').forEach(tab => {
        tab.addEventListener('click', function() {
          document.querySelectorAll('.shop-tabs .leaderboard-tab').forEach(t => t.classList.remove('active'));
          this.classList.add('active');
          
          const category = this.getAttribute('data-category');
          renderShopItems(category);
        });
      });
      
      document.querySelectorAll('.bottom-nav .nav-item').forEach(item => {
        item.addEventListener('click', function() {
          document.querySelectorAll('.bottom-nav .nav-item').forEach(nav => nav.classList.remove('active'));
          this.classList.add('active');
          
          const section = this.id.replace('nav', '').toLowerCase();
          navigateToSection(section);
        });
      });
      
      document.getElementById('copyReferralLink').addEventListener('click', function() {
        const referralLink = document.getElementById('referralLink');
        referralLink.select();
        document.execCommand('copy');
        showMessage('ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ø¥Ø­Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­!');
      });
      
      document.getElementById('copyFriendReferralLink').addEventListener('click', function() {
        const referralLink = document.getElementById('friendReferralLink').textContent;
        const tempInput = document.createElement('input');
        tempInput.value = referralLink;
        document.body.appendChild(tempInput);
        tempInput.select();
        document.execCommand('copy');
        document.body.removeChild(tempInput);
        showMessage('ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯Ø¹ÙˆØ© Ø¨Ù†Ø¬Ø§Ø­! Ø´Ø§Ø±ÙƒÙ‡ Ù…Ø¹ Ø£ØµØ¯Ù‚Ø§Ø¦Ùƒ.');
      });
      
      document.getElementById('createGroupBtn').addEventListener('click', function() {
        createNewGroup();
      });
    }

    function hideAllNewSections() {
      const newSections = ['sectionFriends', 'sectionChallenges', 'sectionGroups', 'sectionReferrals', 'sectionShop'];
      newSections.forEach(sectionId => {
        document.getElementById(sectionId).classList.add('section-hidden');
      });
      
      document.getElementById('sectionHome').classList.remove('section-hidden');
    }

    function navigateToSection(section) {
      const allSections = document.querySelectorAll('#sectionHome, #sectionFriends, #sectionChallenges, #sectionGroups, #sectionReferrals, #sectionShop');
      allSections.forEach(sec => {
        sec.classList.add('section-hidden');
      });
      
      if (section === 'home') {
        document.getElementById('sectionHome').classList.remove('section-hidden');
      } else if (section === 'friends') {
        document.getElementById('sectionFriends').classList.remove('section-hidden');
      } else if (section === 'challenges') {
        document.getElementById('sectionChallenges').classList.remove('section-hidden');
      } else if (section === 'groups') {
        document.getElementById('sectionGroups').classList.remove('section-hidden');
      } else if (section === 'shop') {
        document.getElementById('sectionShop').classList.remove('section-hidden');
      }
      
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // ========== Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù„Ø¹Ø¨Ø© ==========
    async function handleDailyCheckin() {
      if (!gameData.user) {
        showMessage('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø­Ø³Ø§Ø¨Ùƒ...');
        return;
      }
      
      const today = new Date().toISOString().split('T')[0];
      const lastCheckin = gameData.user.lastCheckin;
      
      if (lastCheckin === today) {
        showMessage('Ù„Ù‚Ø¯ Ø³Ø¬Ù„Øª Ø¯Ø®ÙˆÙ„Ùƒ Ø§Ù„ÙŠÙˆÙ… Ø¨Ø§Ù„ÙØ¹Ù„!');
        return;
      }
      
      try {
        const streakBonus = Math.min(gameData.user.streak * 5, 50);
        const basePoints = 50;
        const totalPoints = basePoints + streakBonus;
        
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        const yesterdayStr = yesterday.toISOString().split('T')[0];
        
        let newStreak = 1;
        if (lastCheckin === yesterdayStr) {
          newStreak = gameData.user.streak + 1;
        } else if (lastCheckin === today) {
          showMessage('Ù„Ù‚Ø¯ Ø³Ø¬Ù„Øª Ø¯Ø®ÙˆÙ„Ùƒ Ø§Ù„ÙŠÙˆÙ… Ø¨Ø§Ù„ÙØ¹Ù„!');
          return;
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ù‚Ø§Ø· ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        await updateUserPoints(currentUser.id, totalPoints, 'Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙŠÙˆÙ…ÙŠ');
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØªØ§Ø¨Ø¹ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        await updateUserStreak(currentUser.id, newStreak, today);
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        gameData.user.points += totalPoints;
        gameData.user.streak = newStreak;
        gameData.user.lastCheckin = today;
        gameData.user.level = calculateLevel(gameData.user.points);
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        const checkinTask = gameData.user.dailyTasks.find(t => t.type === 'checkin');
        if (checkinTask && !checkinTask.completed) {
          checkinTask.completed = true;
          saveLocalGameData();
        }
        
        updateUserInfo();
        checkDailyCheckin();
        renderCheckinCalendar();
        renderDailyTasks();
        
        showMessage(`Ù…Ø¨Ø±ÙˆÙƒ! Ù„Ù‚Ø¯ Ø±Ø¨Ø­Øª ${totalPoints.toLocaleString('en-US')} Ù†Ù‚Ø·Ø© (${basePoints.toLocaleString('en-US')} + ${streakBonus.toLocaleString('en-US')} Ù…ÙƒØ§ÙØ£Ø© ØªØªØ§Ø¨Ø¹)`);
        animatePoints(totalPoints);
        
        checkAchievements();
        
      } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„ÙŠÙˆÙ…ÙŠ:', error);
        showMessage('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙŠÙˆÙ…ÙŠ');
      }
    }

    async function completeTask(taskId) {
      if (!gameData.user) return;
      
      const task = gameData.user.dailyTasks.find(t => t.id === taskId);
      
      if (!task || task.completed) {
        showMessage('Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù‡Ù…Ø© Ù…ÙƒØªÙ…Ù„Ø© Ø¨Ø§Ù„ÙØ¹Ù„!');
        return;
      }
      
      try {
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ù‚Ø§Ø· ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        await updateUserPoints(currentUser.id, task.reward, `Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ù…Ù‡Ù…Ø©: ${task.title}`);
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        gameData.user.points += task.reward;
        gameData.user.level = calculateLevel(gameData.user.points);
        task.completed = true;
        
        // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        saveLocalGameData();
        
        updateUserInfo();
        renderDailyTasks();
        
        showMessage(`Ø£Ø­Ø³Ù†Øª! Ø£ÙƒÙ…Ù„Øª Ø§Ù„Ù…Ù‡Ù…Ø© ÙˆØ±Ø¨Ø­Øª ${task.reward.toLocaleString('en-US')} Ù†Ù‚Ø·Ø©`);
        animatePoints(task.reward);
        
        checkAchievements();
        
      } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ù…Ù‡Ù…Ø©:', error);
        showMessage('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ù…Ù‡Ù…Ø©');
      }
    }

    async function sendGiftToFriend(friendId) {
      try {
        const friend = gameData.friends.find(f => f.id === friendId);
        if (!friend) {
          showMessage('Ø§Ù„ØµØ¯ÙŠÙ‚ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
          return;
        }
        
        if (gameData.user.points < 50) {
          showMessage('Ù†Ù‚Ø§Ø·Ùƒ ØºÙŠØ± ÙƒØ§ÙÙŠØ© Ù„Ø¥Ø±Ø³Ø§Ù„ Ù‡Ø¯ÙŠØ©');
          return;
        }
        
        // Ø®ØµÙ… Ø§Ù„Ù†Ù‚Ø§Ø· ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        await updateUserPoints(currentUser.id, -50, `Ø¥Ø±Ø³Ø§Ù„ Ù‡Ø¯ÙŠØ© Ø¥Ù„Ù‰ ${friend.name}`);
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        gameData.user.points -= 50;
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        const giftTask = gameData.user.dailyTasks.find(t => t.type === 'gift');
        if (giftTask && !giftTask.completed) {
          giftTask.completed = true;
          saveLocalGameData();
        }
        
        updateUserInfo();
        renderDailyTasks();
        
        showMessage(`ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ù‡Ø¯ÙŠØ© Ø¥Ù„Ù‰ ${friend.name} (ÙƒÙ„ÙØª 50 Ù†Ù‚Ø·Ø©)`);
        
      } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù‡Ø¯ÙŠØ©:', error);
        showMessage('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù‡Ø¯ÙŠØ©');
      }
    }

    async function sendGift(giftId) {
      const gift = gameData.gifts.find(g => g.id === giftId);
      if (!gift || !gift.sendable) return;
      
      if (gameData.user.points < gift.points) {
        showMessage('Ù†Ù‚Ø§Ø·Ùƒ ØºÙŠØ± ÙƒØ§ÙÙŠØ© Ù„Ø¥Ø±Ø³Ø§Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ù‡Ø¯ÙŠØ©!');
        return;
      }
      
      showMessage(`Ø§Ø®ØªØ± ØµØ¯ÙŠÙ‚Ø§Ù‹ Ù„Ø¥Ø±Ø³Ø§Ù„ ${gift.title} Ø¥Ù„ÙŠÙ‡`);
    }

    async function startChallenge(challengeId) {
      const challenge = gameData.challenges.find(c => c.id === challengeId);
      if (!challenge) return;
      
      showMessage(`Ø¨Ø¯Ø£Øª ØªØ­Ø¯ÙŠ "${challenge.title}"! Ù„Ø¯ÙŠÙƒ ${challenge.timeLeft} Ù„Ø¥ÙƒÙ…Ø§Ù„Ù‡.`);
    }

    async function toggleGroupJoin(groupId) {
      showMessage('Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø© Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±. Ø³ØªÙƒÙˆÙ† Ù…ØªØ§Ø­Ø© Ù‚Ø±ÙŠØ¨Ø§Ù‹!');
    }

    async function createNewGroup() {
      const groupName = prompt('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:');
      if (!groupName || groupName.trim() === '') return;
      
      showMessage(`ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù…ÙˆØ¹Ø© "${groupName}" Ø¨Ù†Ø¬Ø§Ø­!`);
    }

    async function purchaseItem(itemId) {
      const item = gameData.shopItems.find(i => i.id === itemId);
      if (!item) return;
      
      if (gameData.user.points < item.points) {
        showMessage('Ù†Ù‚Ø§Ø·Ùƒ ØºÙŠØ± ÙƒØ§ÙÙŠØ© Ù„Ø´Ø±Ø§Ø¡ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù†ØµØ±!');
        return;
      }
      
      if (confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø´Ø±Ø§Ø¡ "${item.title}" Ù…Ù‚Ø§Ø¨Ù„ ${item.points.toLocaleString('en-US')} Ù†Ù‚Ø·Ø©ØŸ`)) {
        try {
          // Ø®ØµÙ… Ø§Ù„Ù†Ù‚Ø§Ø· ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
          await updateUserPoints(currentUser.id, -item.points, `Ø´Ø±Ø§Ø¡ Ù…Ù† Ø§Ù„Ù…ØªØ¬Ø±: ${item.title}`);
          
          // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
          gameData.user.points -= item.points;
          gameData.user.level = calculateLevel(gameData.user.points);
          
          updateUserInfo();
          renderShopItems();
          
          showMessage(`ØªÙ… Ø´Ø±Ø§Ø¡ "${item.title}" Ø¨Ù†Ø¬Ø§Ø­! Ø´ÙƒØ±Ø§Ù‹ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ùƒ Ù…ØªØ¬Ø± Crynova.`);
          
        } catch (error) {
          console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø´Ø±Ø§Ø¡ Ø§Ù„Ø¹Ù†ØµØ±:', error);
          showMessage('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø´Ø±Ø§Ø¡');
        }
      }
    }

    async function claimReferralReward(rewardId) {
      const reward = gameData.referrals.rewardsList.find(r => r.id === rewardId);
      if (!reward || !reward.achieved) {
        showMessage('Ù„Ù… ØªØ­Ù‚Ù‚ Ø´Ø±ÙˆØ· Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙƒØ§ÙØ£Ø© Ø¨Ø¹Ø¯');
        return;
      }
      
      try {
        if (typeof reward.reward === 'number') {
          // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Ù‚Ø§Ø· ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
          await updateUserPoints(currentUser.id, reward.reward, `Ù…ÙƒØ§ÙØ£Ø© Ø§Ù„Ø¥Ø­Ø§Ù„Ø©: ${reward.title}`);
          
          // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
          gameData.user.points += reward.reward;
          gameData.user.level = calculateLevel(gameData.user.points);
          
          showMessage(`Ù…Ø¨Ø±ÙˆÙƒ! Ø­ØµÙ„Øª Ø¹Ù„Ù‰ ${reward.reward.toLocaleString('en-US')} Ù†Ù‚Ø·Ø© Ù…ÙƒØ§ÙØ£Ø©`);
        } else {
          showMessage(`Ù…Ø¨Ø±ÙˆÙƒ! Ø­ØµÙ„Øª Ø¹Ù„Ù‰ ${reward.reward}`);
        }
        
        updateUserInfo();
        renderReferrals();
        
      } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©:', error);
        showMessage('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©');
      }
    }

    async function checkAchievements() {
      if (!gameData.user || !gameData.user.achievements) return;
      
      let updated = false;
      
      if (gameData.user.points >= 1000) {
        const achievement = gameData.user.achievements.find(a => a.id === 1);
        if (achievement && !achievement.unlocked) {
          achievement.unlocked = true;
          updated = true;
        }
      }
      
      if (gameData.user.streak >= 7) {
        const achievement = gameData.user.achievements.find(a => a.id === 2);
        if (achievement && !achievement.unlocked) {
          achievement.unlocked = true;
          updated = true;
        }
      }
      
      if (gameData.user.points >= 5000) {
        const achievement = gameData.user.achievements.find(a => a.id === 4);
        if (achievement && !achievement.unlocked) {
          achievement.unlocked = true;
          updated = true;
        }
      }
      
      if (gameData.user.referrals >= 5) {
        const achievement = gameData.user.achievements.find(a => a.id === 3);
        if (achievement && !achievement.unlocked) {
          achievement.unlocked = true;
          updated = true;
        }
      }
      
      if (updated) {
        saveLocalGameData();
        renderAchievements();
      }
    }

    // ========== ØªÙ‡ÙŠØ¦Ø© Telegram WebApp ==========
    async function initializeTelegramWebApp() {
      try {
        console.log('ğŸ”„ Ø¨Ø¯Ø¡ ØªÙ‡ÙŠØ¦Ø© Telegram WebApp...');
        
        if (!window.Telegram || !Telegram.WebApp) {
          console.log('âŒ Telegram WebApp ØºÙŠØ± Ù…ØªÙˆÙØ±ØŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©');
          await useMockData();
          return;
        }
        
        const tg = Telegram.WebApp;
        
        tg.expand();
        tg.setBackgroundColor('#ffffff');
        tg.enableClosingConfirmation();
        
        const user = tg.initDataUnsafe?.user;
        const startParam = tg.initDataUnsafe?.start_param;
        
        if (!user || !user.id) {
          console.log('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Telegram');
          await useMockData();
          return;
        }
        
        console.log('ğŸ‘¤ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø³ØªØ®Ø¯Ù… Telegram:', user);
        console.log('ğŸ”— Ù…Ø¹Ø§Ù…Ù„ Ø§Ù„Ø¥Ø­Ø§Ù„Ø©:', startParam);
        
        currentUser = {
          id: user.id.toString(),
          telegramId: user.id.toString(),
          firstName: user.first_name || 'Ù…Ø³ØªØ®Ø¯Ù…',
          lastName: user.last_name || '',
          username: user.username || null,
          languageCode: user.language_code || 'ar'
        };
        
        try {
          const registeredUser = await registerUserIfNeeded(user);
          
          if (registeredUser) {
            console.log('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„/ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', registeredUser);
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ù…Ø¹Ø§Ù…Ù„ Ø¥Ø­Ø§Ù„Ø©ØŒ Ù†Ù‚ÙˆÙ… Ø¨ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¥Ø­Ø§Ù„Ø©
            if (startParam && startParam !== '' && startParam !== currentUser.id) {
              const referrerId = startParam;
              if (referrerId !== currentUser.id) {
                await addReferralToDatabase(referrerId, currentUser.id);
                showMessage('ğŸ‰ ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¥Ø­Ø§Ù„ØªÙƒ Ø¨Ù†Ø¬Ø§Ø­! Ø´ÙƒØ±Ø§Ù‹ Ù„Ù„Ø§Ù†Ø¶Ù…Ø§Ù….');
              }
            }
          }
        } catch (error) {
          console.error('âš ï¸ Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', error);
        }
        
        updateUserInterface(currentUser);
        
        await initializeGame();
        
        updateFirebaseStatus('success', 'âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­');
        
      } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Telegram WebApp:', error);
        await useMockData();
      }
    }

    async function useMockData() {
      console.log('ğŸ”„ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©...');
      
      const mockUser = {
        id: 5922049376,
        first_name: 'Akram',
        last_name: 'Khezzari', 
        username: 'A_mja_d_0_5',
        language_code: 'ar'
      };
      
      currentUser = {
        id: mockUser.id.toString(),
        telegramId: mockUser.id.toString(),
        firstName: mockUser.first_name,
        lastName: mockUser.last_name,
        username: mockUser.username,
        languageCode: mockUser.language_code
      };
      
      if (db) {
        try {
          await registerUserIfNeeded(mockUser);
        } catch (error) {
          console.log('âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠ:', error);
        }
      }
      
      await initializeGame();
    }

    function updateUserInterface(user) {
      if (user) {
        console.log('ğŸ‘¤ ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', user.firstName);
      }
    }

    // ========== ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© ==========
    async function initializeGame() {
      try {
        console.log('ğŸ”„ Ø¨Ø¯Ø¡ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©...');
        
        const loaded = await loadUserData();
        if (!loaded) {
          throw new Error("ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø©");
        }
        
        updateUserInfo();
        renderCheckinCalendar();
        renderDailyTasks();
        renderAchievements();
        
        await loadAdditionalData();
        
        setupEventListeners();
        checkDailyCheckin();
        hideAllNewSections();
        
        document.getElementById('gameContainer').style.display = 'block';
        document.querySelector('.bottom-nav').style.display = 'flex';
        
        hideLoading();
        
        setTimeout(() => {
          showMessage(`Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ${gameData.user.name}! Ø§Ø³ØªÙ…ØªØ¹ Ø¨Ù„Ø¹Ø¨Ø© Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„ÙŠÙˆÙ…ÙŠØ©`);
        }, 1000);
        
        console.log('âœ… ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¨Ù†Ø¬Ø§Ø­');
        
      } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©:', error);
        showMessage('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù„Ø¹Ø¨Ø©. ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©.');
        hideLoading();
        
        document.getElementById('gameContainer').style.display = 'block';
        document.querySelector('.bottom-nav').style.display = 'flex';
      }
    }

    // ========== Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ==========
    document.addEventListener('DOMContentLoaded', function() {
      console.log('ğŸš€ Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ù„Ø¹Ø¨Ø© Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„ÙŠÙˆÙ…ÙŠØ©...');
      
      if (!firebaseApp) {
        document.querySelector('.loading-text').textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…. ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©.';
        console.error('Firebase not initialized');
        return;
      }
      
      showLoading();
      
      setTimeout(() => {
        initializeTelegramWebApp();
      }, 500);
    });
  </script>
</body>
</html>
